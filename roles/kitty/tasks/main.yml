---
- name: Install kitty terminal (Fedora)
  dnf:
    name: kitty
    state: present
  when:
    - ansible_facts['distribution'] == 'Fedora'
    - system_pkg_mgr in dnf_like_pkg_mgrs
    - not skip_system_dependencies | bool
  become: true
  tags: ['install']

- name: Layer kitty terminal (rpm-ostree)
  community.general.rpm_ostree_pkg:
    name: kitty
    state: present
  when:
    - ansible_facts['distribution'] == 'Fedora'
    - system_pkg_mgr in rpm_ostree_like_pkg_mgrs
    - not skip_system_dependencies | bool
  become: true
  tags: ['install']

- name: Install kitty terminal (Ubuntu/Debian)
  apt:
    name: kitty
    state: present
  when:
    - ansible_facts['distribution'] in ['Debian', 'Ubuntu']
    - not skip_system_dependencies | bool
  become: true
  tags: ['install']

- name: Install kitty terminal (openSUSE)
  zypper:
    name: kitty
    state: present
  when:
    - ansible_facts['os_family'] == 'Suse'
    - not skip_system_dependencies | bool
  become: true
  tags: ['install']

- name: Install kitty terminal (Arch)
  pacman:
    name: kitty
    state: present
  when:
    - ansible_facts['distribution'] == 'Archlinux'
    - not skip_system_dependencies | bool
  become: true
  tags: ['install']

- name: Check if wpg binary is available
  stat:
    path: "{{ wpg_binary }}"
  register: wpg_binary_stat
  become: false

- name: Set wpgtk availability fact for kitty role
  set_fact:
    wpgtk_available: "{{ wpg_binary_stat.stat.exists | bool }}"

- name: Ensure kitty config directory exists
  file:
    path: "{{ kitty_config_dir }}"
    state: directory
    mode: '0755'
  become: false

- name: Remove kitty.conf from wpgtk templates
  command: "{{ wpg_binary }} -t -d {{ kitty_config_dir }}/kitty.conf"
  become: false
  failed_when: false
  changed_when: false
  environment:
    PATH: "{{ user_local_bin }}:{{ user_default_path }}"
  when:
    - wpgtk_install_templates | bool
    - wpgtk_available | default(false)

- name: Copy kitty configuration
  copy:
    src: "{{ playbook_dir }}/Backup-.configs/kitty/kitty.conf"
    dest: "{{ kitty_config_dir }}/kitty.conf"
    mode: '0644'
    force: true
  become: false
  notify: Reapply wpgtk theme

- name: Escape Vim fold markers for wpgtk (opening)
  replace:
    path: "{{ kitty_config_dir }}/kitty.conf"
    regexp: '(\{\{\{)'
    replace: '{{ "{{" }}{{ "{{" }}'
  become: false
  when: wpgtk_install_templates | bool

- name: Escape Vim fold markers for wpgtk (closing)
  replace:
    path: "{{ kitty_config_dir }}/kitty.conf"
    regexp: '(\}\}\})'
    replace: '{{ "}}" }}{{ "}}" }}'
  become: false
  when: wpgtk_install_templates | bool

- name: Escape kitty template variable {title} for wpgtk
  replace:
    path: "{{ kitty_config_dir }}/kitty.conf"
    regexp: '(\{title\})'
    replace: '{{ "{{title}}" }}'
  become: false
  when: wpgtk_install_templates | bool

- name: Escape kitty template variable {index} for wpgtk
  replace:
    path: "{{ kitty_config_dir }}/kitty.conf"
    regexp: '(\{index\})'
    replace: '{{ "{{index}}" }}'
  become: false
  when: wpgtk_install_templates | bool

- name: Escape kitty template variable {HOME} for wpgtk
  replace:
    path: "{{ kitty_config_dir }}/kitty.conf"
    regexp: '(\{HOME\})'
    replace: '{{ "{{HOME}}" }}'
  become: false
  when: wpgtk_install_templates | bool

- name: Escape kitty template variable {MYVAR1} for wpgtk
  replace:
    path: "{{ kitty_config_dir }}/kitty.conf"
    regexp: '(\{MYVAR1\})'
    replace: '{{ "{{MYVAR1}}" }}'
  become: false
  when: wpgtk_install_templates | bool

- name: Register kitty.conf as wpgtk template
  command: "{{ wpg_binary }} -ta {{ kitty_config_dir }}/kitty.conf"
  become: false
  failed_when: false
  changed_when: false
  register: wpgtk_kitty_result
  environment:
    PATH: "{{ user_local_bin }}:{{ user_default_path }}"
  when:
    - wpgtk_install_templates | bool
    - wpgtk_available | default(false)

- name: Report wpgtk registration status for Kitty
  debug:
    msg: "Kitty config {{ 'registered with wpgtk' if wpgtk_kitty_result.rc == 0 else 'not registered - wpgtk may not be installed or configured' }}"
  when:
    - wpgtk_install_templates | bool
    - wpgtk_available | default(false)

- name: Skipping wpgtk registration for Kitty
  debug:
    msg: "Skipped registering Kitty config with wpgtk because the wpgtk tooling is unavailable"
  when:
    - wpgtk_install_templates | bool
    - not (wpgtk_available | default(false))
