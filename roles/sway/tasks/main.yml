---
- name: Check if wpg binary is available
  stat:
    path: "{{ wpg_binary }}"
  register: wpg_binary_stat
  become: false

- name: Set wpgtk availability fact for sway role
  set_fact:
    wpgtk_available: "{{ wpg_binary_stat.stat.exists | bool }}"

- name: Ensure sway config directory exists
  file:
    path: "{{ sway_config_dir }}"
    state: directory
    mode: '0755'
  become: false

- name: Get current wpgtk wallpaper
  command: "{{ wpg_binary }} -c"
  register: current_wallpaper
  become: false
  failed_when: false
  changed_when: false
  environment:
    PATH: "{{ user_local_bin }}:{{ user_default_path }}"
  when: wpgtk_available | default(false)

- name: Set wallpaper path fact
  set_fact:
    wpg_wallpaper_path: "{{ user_home }}/.config/wpg/wallpapers/{{ current_wallpaper.stdout | trim }}"
    wpg_lock_path: "{{ user_home }}/.config/wpg/wallpapers/{{ current_wallpaper.stdout | trim }}.lock.png"
  when:
    - wpgtk_available | default(false)
    - current_wallpaper.stdout is defined
    - current_wallpaper.stdout | trim | length > 0

- name: Check if wallpaper file exists
  stat:
    path: "{{ wpg_wallpaper_path }}"
  register: wallpaper_file
  become: false
  when:
    - wpgtk_available | default(false)
    - wpg_wallpaper_path is defined

- name: Resolve actual wallpaper path
  command:
    argv:
      - readlink
      - -f
      - "{{ wpg_wallpaper_path }}"
  register: resolved_wallpaper_path
  become: false
  changed_when: false
  when:
    - wpgtk_available | default(false)
    - wallpaper_file.stat.exists | default(false)

- name: Update wallpaper source to resolved location for blur generation
  set_fact:
    # Use the resolved (real) wallpaper as the source for ImageMagick
    wpg_wallpaper_source: "{{ resolved_wallpaper_path.stdout | default('') | trim | default(wpg_wallpaper_path, true) }}"
    # Keep lock path at symlink location (where sway config expects it)
    # This ensures sway's {wallpaper}.lock.png reference works correctly
  when:
    - wpgtk_available | default(false)
    - wallpaper_file.stat.exists | default(false)
    - resolved_wallpaper_path.stdout is defined
    - resolved_wallpaper_path.stdout | trim | length > 0

- name: Check if blurred lock wallpaper exists
  stat:
    path: "{{ wpg_lock_path }}"
  register: lock_file
  become: false
  when:
    - wpgtk_available | default(false)
    - wpg_lock_path is defined

- name: Create blurred lock screen wallpaper using imagemagick
  command: "magick '{{ wpg_wallpaper_source | default(wpg_wallpaper_path) }}' -gaussian-blur 0x7 '{{ wpg_lock_path }}'"
  become: false
  register: magick_result
  changed_when: lock_file_after.stat.exists
  when:
    - wpgtk_available | default(false)
    - wallpaper_file.stat.exists | default(false)
    - not (lock_file.stat.exists | default(false))


- name: Check if blurred lock wallpaper exists after magick
  stat:
    path: "{{ wpg_lock_path }}"
  register: lock_file_after
  become: false
  when:
    - wpgtk_available | default(false)
    - wpg_lock_path is defined
- name: Remove old wpgtk sway template base file
  file:
    path: "{{ user_home }}/.config/wpg/templates/config_sway_config.base"
    state: absent
  become: false
  when:
    - wpgtk_install_templates | bool
    - wpgtk_available | default(false)

- name: Remove sway config from wpgtk templates
  command: "{{ wpg_binary }} -t -d {{ sway_config_dir }}/config"
  become: false
  failed_when: false
  changed_when: false
  environment:
    PATH: "{{ user_local_bin }}:{{ user_default_path }}"
  when:
    - wpgtk_install_templates | bool
    - wpgtk_available | default(false)

- name: Copy sway configuration from backup
  copy:
    src: "{{ playbook_dir }}/Backup-.configs/sway/config"
    dest: "{{ sway_config_dir }}/config"
    mode: '0644'
    force: true
  become: false
  notify: Reapply wpgtk theme

- name: Register sway config as wpgtk template
  command: "{{ wpg_binary }} -ta {{ sway_config_dir }}/config"
  become: false
  failed_when: false
  changed_when: false
  register: wpgtk_sway_result
  environment:
    PATH: "{{ user_local_bin }}:{{ user_default_path }}"
  when:
    - wpgtk_install_templates | bool
    - wpgtk_available | default(false)

- name: Report wpgtk registration status for Sway
  debug:
    msg: "Sway config {{ 'registered with wpgtk' if wpgtk_sway_result.rc == 0 else 'not registered - wpgtk may not be installed or configured' }}"
  when:
    - wpgtk_install_templates | bool
    - wpgtk_available | default(false)

- name: Skipping wpgtk registration for Sway
  debug:
    msg: "Skipped registering Sway config with wpgtk because the wpgtk tooling is unavailable"
  when:
    - wpgtk_install_templates | bool
    - not (wpgtk_available | default(false))

- name: Ensure sway is set as default session (optional)
  lineinfile:
    path: "{{ lookup('env', 'HOME') }}/.bash_profile"
    line: 'if [ -z "$WAYLAND_DISPLAY" ] && [ "$XDG_VTNR" -eq 1 ]; then exec sway; fi'
    create: yes
  become: false
  when: false  # Set to true if you want auto-start sway on login
