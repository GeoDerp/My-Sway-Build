---
- name: Check if uv is installed
  command: which uv
  register: uv_installed
  failed_when: false
  changed_when: false
  become: false

- name: Check for uv binary in user cargo bin
  stat:
    path: "{{ uv_binary }}"
  register: uv_binary_stat
  become: false

- name: Create local tooling directories
  file:
    path: "{{ item }}"
    state: directory
    mode: '0755'
  loop:
    - "{{ user_home }}/.cargo"
    - "{{ user_cargo_bin }}"
    - "{{ user_local_bin }}"
  become: false

- name: Install uv if not present
  shell: curl -LsSf https://astral.sh/uv/install.sh | sh
  when: uv_installed.rc != 0 and not uv_binary_stat.stat.exists
  become: false
  args:
    creates: "{{ uv_binary }}"

- name: Install wpgtk via uv tool
  command: uv tool install wpgtk
  args:
    creates: "{{ wpg_binary }}"
  become: false
  environment:
    PATH: "{{ user_cargo_bin }}:{{ user_default_path }}"
  register: wpgtk_install
  failed_when: false
  changed_when: "'installed' in (wpgtk_install.stdout | default('') | lower) or 'installed' in (wpgtk_install.stderr | default('') | lower)"

- name: Ensure wpgtk config directory exists
  file:
    path: "{{ wpgtk_home }}/.config/wpg"
    state: directory
    mode: '0755'
  become: false

- name: Find wpgtk installation script
  find:
    paths: "{{ wpgtk_home }}/.local/lib"
    patterns: "wpg-install.sh"
    recurse: yes
  register: wpgtk_script
  become: false

- name: Install wpgtk templates for various applications
  shell: |
    "{{ wpgtk_script.files[0].path }}" -gGi
  args:
    creates: "{{ wpgtk_home }}/.themes"
  become: false
  when: wpgtk_script.files | length > 0 and wpgtk_script.files[0] is defined
  failed_when: false
  register: wpgtk_install_result
  changed_when: not (wpgtk_install_result.skipped | default(false))

- name: Report wpgtk template installation status
  debug:
    msg: "wpgtk templates installation {{ 'succeeded' if wpgtk_install_result.rc == 0 else 'skipped or failed - may need manual installation' }}"
  when: wpgtk_script.files | length > 0

- name: Set GNOME theme to linea-nord-color (if using GNOME)
  shell: |
    gsettings set org.gnome.desktop.wm.preferences theme "linea-nord-color"
    gsettings set org.gnome.desktop.interface theme "linea-nord-color"
    gsettings set org.gnome.desktop.interface icon-theme "Flattcolor-dark"
  become: false
  failed_when: false
  changed_when: false
  when: lookup('env', 'XDG_CURRENT_DESKTOP') == 'GNOME'
  register: gnome_theme_result

- name: Report GNOME theme status
  debug:
    msg: "GNOME theme {{ 'applied successfully' if gnome_theme_result.rc == 0 else 'not applied - not using GNOME or themes not available' }}"
  when: lookup('env', 'XDG_CURRENT_DESKTOP') == 'GNOME'

- name: Check if wpg binary is available
  stat:
    path: "{{ wpg_binary }}"
  register: wpg_binary_stat_final
  become: false

- name: Publish wpgtk availability fact
  set_fact:
    wpgtk_available: "{{ wpg_binary_stat_final.stat.exists | bool }}"

- name: Force reapply wpgtk theme (ensure placeholders get replaced)
  command: "{{ wpg_binary }} -r"
  become: false
  failed_when: false
  changed_when: false
  environment:
    PATH: "{{ user_local_bin }}:{{ user_cargo_bin }}:{{ user_default_path }}"
    HOME: "{{ wpgtk_home }}"
  args:
    chdir: "{{ wpgtk_home }}"
  when: wpgtk_available | default(false)

- name: Install lock-wrapper to user's local bin
  copy:
    src: lock-wrapper
    dest: "{{ user_local_bin }}/lock-wrapper"
    mode: '0755'
    force: true
  become: false
  when: wpgtk_available | default(false)
