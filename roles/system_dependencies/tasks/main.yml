---
- name: Install base system dependencies (Fedora)
  dnf:
    name:
      - sway
      - swaylock
      - swayidle
      - waybar
      - python3
      - ImageMagick  # for blurring lock screen wallpaper
      - brightnessctl  # for laptop brightness control
      - playerctl  # for media controls
      - grim  # screenshot tool
      - slurp  # region selector for screenshots
      - wf-recorder  # screen recording
      - wl-clipboard  # clipboard utilities
      - mako  # notification daemon (alternative to dunst)
      - git
      - fontawesome-fonts
      - gnome-themes-extra
    state: present
  when:
    - ansible_facts['distribution'] == 'Fedora'
    - system_pkg_mgr in dnf_like_pkg_mgrs
  become: true

- name: Check for missing packages (rpm-ostree)
  ansible.builtin.shell: |
    packages="swaylock swayidle waybar python3 ImageMagick brightnessctl playerctl grim slurp wf-recorder wl-clipboard mako git fontawesome-fonts gnome-themes-extra"
    missing=""
    for pkg in $packages; do
      if ! rpm -q "$pkg" &>/dev/null; then
        missing="$missing $pkg"
      fi
    done
    echo "$missing"
  register: missing_packages
  changed_when: false
  when:
    - ansible_facts['distribution'] == 'Fedora'
    - system_pkg_mgr in rpm_ostree_like_pkg_mgrs

- name: Layer base system dependencies (rpm-ostree)
  ansible.builtin.command:
    cmd: "rpm-ostree install{{ missing_packages.stdout }}"
  when:
    - ansible_facts['distribution'] == 'Fedora'
    - system_pkg_mgr in rpm_ostree_like_pkg_mgrs
    - missing_packages.stdout | trim | length > 0
  become: true
  register: rpm_ostree_install
  changed_when: "'Staging deployment' in rpm_ostree_install.stdout or 'Upgraded' in rpm_ostree_install.stdout"

- name: Notify user about reboot requirement (rpm-ostree)
  ansible.builtin.debug:
    msg: "System packages have been layered. A reboot is required to apply changes."
  when:
    - ansible_facts['distribution'] == 'Fedora'
    - system_pkg_mgr in rpm_ostree_like_pkg_mgrs
    - rpm_ostree_install is defined
    - rpm_ostree_install.changed

- name: Install base system dependencies (Debian/Ubuntu)
  apt:
    name:
      - sway
      - swaylock
      - swayidle
      - waybar
      - python3
      - imagemagick
      - brightnessctl
      - playerctl
      - grim
      - slurp
      - wf-recorder
      - wl-clipboard
      - mako-notifier
      - git
      - fonts-font-awesome
      - gnome-themes-extra
    state: present
    update_cache: yes
  when: ansible_facts['distribution'] in ['Debian', 'Ubuntu']
  become: true

- name: Install base system dependencies (openSUSE)
  zypper:
    name:
      - sway
      - swaylock
      - swayidle
      - waybar
      - python3
      - ImageMagick
      - brightnessctl
      - playerctl
      - grim
      - slurp
      - wf-recorder
      - wl-clipboard
      - mako
      - git
      - fontawesome-fonts
      - gnome-themes-extra
    state: present
    update_cache: yes
  when: ansible_facts['os_family'] == 'Suse'
  become: true

- name: Install base system dependencies (Arch)
  pacman:
    name:
      - sway
      - swaylock
      - swayidle
      - waybar
      - python
      - imagemagick
      - brightnessctl
      - playerctl
      - grim
      - slurp
      - wf-recorder
      - wl-clipboard
      - mako
      - git
      - ttf-font-awesome
      - gnome-themes-extra
    state: present
  when: ansible_facts['distribution'] == 'Archlinux'
  become: true
