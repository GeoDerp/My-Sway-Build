---
- name: Install base system dependencies (Fedora)
  dnf:
    name:
      - sway
      - swaylock
      - swayidle
      - waybar
      - python3
      - ImageMagick  # for blurring lock screen wallpaper
      - brightnessctl  # for laptop brightness control
      - playerctl  # for media controls
      - grim  # screenshot tool
      - slurp  # region selector for screenshots
      - wf-recorder  # screen recording
      - wl-clipboard  # clipboard utilities
      - mako  # notification daemon (alternative to dunst)
      - git
      - fontawesome-fonts
      - gnome-themes-extra
    state: present
  when:
    - ansible_facts['distribution'] == 'Fedora'
    - system_pkg_mgr in dnf_like_pkg_mgrs
  become: true
  
- name: "Preflight: detect whether sudo will be non-interactive"
  ansible.builtin.command:
    cmd: sudo -n true
  register: sudo_noninteractive_check
  changed_when: false
  failed_when: false
  when:
    - ansible_facts['distribution'] == 'Fedora'
    - system_pkg_mgr in rpm_ostree_like_pkg_mgrs

- name: Warn if sudo requires a password (rpm-ostree)
  ansible.builtin.debug:
    msg: "Sudo may require a password; re-run with --ask-become-pass or configure passwordless sudo for non-interactive installs."
  when:
    - ansible_facts['distribution'] == 'Fedora'
    - system_pkg_mgr in rpm_ostree_like_pkg_mgrs
    - sudo_noninteractive_check is defined
    - sudo_noninteractive_check.rc != 0

- name: Layer base system dependencies (rpm-ostree)
  community.general.rpm_ostree_pkg:
    name:
      - swaylock
      - swayidle
      - waybar
      - python3
      - ImageMagick
      - brightnessctl
      - playerctl
      - grim
      - slurp
      - wf-recorder
      - wl-clipboard
      - mako
      - git
      - fontawesome-fonts
      - gnome-themes-extra
    state: present
  when:
    - ansible_facts['distribution'] == 'Fedora'
    - system_pkg_mgr in rpm_ostree_like_pkg_mgrs
    - not skip_system_dependencies | bool
    - "(sudo_noninteractive_check is defined and sudo_noninteractive_check.rc == 0) or ansible_become_pass is defined"
  become: true
  register: rpm_ostree_install
  changed_when: rpm_ostree_install.stdout is defined and ('Staging deployment' in rpm_ostree_install.stdout or 'Upgraded' in rpm_ostree_install.stdout)

- name: Notify user about reboot requirement (rpm-ostree)
  ansible.builtin.debug:
    msg: "System packages have been layered. A reboot is required to apply changes."
  when:
    - ansible_facts['distribution'] == 'Fedora'
    - system_pkg_mgr in rpm_ostree_like_pkg_mgrs
    - rpm_ostree_install is defined
    - rpm_ostree_install.changed

- name: Install base system dependencies (Debian/Ubuntu)
  apt:
    name:
      - sway
      - swaylock
      - swayidle
      - waybar
      - python3
      - imagemagick
      - brightnessctl
      - playerctl
      - grim
      - slurp
      - wf-recorder
      - wl-clipboard
      - mako-notifier
      - git
      - fonts-font-awesome
      - gnome-themes-extra
    state: present
    update_cache: yes
  when: ansible_facts['distribution'] in ['Debian', 'Ubuntu']
  become: true

- name: Install base system dependencies (openSUSE)
  zypper:
    name:
      - sway
      - swaylock
      - swayidle
      - waybar
      - python3
      - ImageMagick
      - brightnessctl
      - playerctl
      - grim
      - slurp
      - wf-recorder
      - wl-clipboard
      - mako
      - git
      - fontawesome-fonts
      - gnome-themes-extra
    state: present
    update_cache: yes
  when: ansible_facts['os_family'] == 'Suse'
  become: true

- name: Install base system dependencies (Arch)
  pacman:
    name:
      - sway
      - swaylock
      - swayidle
      - waybar
      - python
      - imagemagick
      - brightnessctl
      - playerctl
      - grim
      - slurp
      - wf-recorder
      - wl-clipboard
      - mako
      - git
      - ttf-font-awesome
      - gnome-themes-extra
    state: present
  when: ansible_facts['distribution'] == 'Archlinux'
  become: true
